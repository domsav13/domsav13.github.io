---
layout: post
title: Controls for a 2D Rocket
date: 2025-12-10 11:12:00-0400
description: LQG and model predictive control of a rocket for hovering, landing, and waypoint flight
tags: 
categories: 
thumbnail: assets/img/2drocket.jpg
related_posts: false
---

### Problem Setup and 2D Rocket Dynamics

This project is a exploration of control system design based on the 2D rocket dynamics below, inspired by SpaceX's self-landing rockets.

<div class="row mt-3">
    <div class="col-12 col-md-6 mx-auto mt-3 mt-md-0">
        {% include figure.liquid loading="eager" path="assets/img/2drocket.jpg" class="img-fluid rounded z-depth-1" %}
    </div>
</div>
<div class="caption">
    2D rocket free body diagram
</div>

First, the linear and rotational equations of motion are collected by summing the system's forces and moments:

$$
\begin{aligned}
m\ddot{p}&=f_g+f_t\\
J\ddot{\theta}&=r \times f_t
\end{aligned}
$$

The input to the system is the thrust vector $$ f_t $$, which can be broken into magnitude $$ \rho $$ and angle $$ \phi $$. Therefore, in the rocket body fixed frame, the thrust vector can be expressed as $$ f_t' = \rho\begin{bmatrix}\sin\phi&\cos\phi\end{bmatrix}^T $$. To convert between the body fixed frame and the global frame, a rotation matrix is used with the thrust term in the first equation of motion:

$$
\begin{aligned}
m\ddot{p}&=f_g+\rho\begin{bmatrix}\cos\theta^-\sin\theta\\\sin\theta&\cos\theta\end{bmatrix}\begin{bmatrix}\sin\phi\\\cos\phi\end{bmatrix}\\[4pt]
&= f_g + \rho\begin{bmatrix}\cos\theta\sin\phi-\sin\theta\cos\phi\\\sin\theta\sin\phi+\cos\theta\cos\phi\end{bmatrix} \\[4pt]
&= f_g + \rho\begin{bmatrix}\sin(\phi-\theta)\\\cos(\phi-\theta)\end{bmatrix}
\end{aligned}
$$

In the global frame, the gravitational force is constant with $$ g $$ as the acceleration due to gravity: $$ f_g = \begin{bmatrix}0&-mg\end{bmatrix}^T $$. 

In the body fixed frame, the position of the thruster $$ r $$ is constant assuming the body fixed y-axis points forward. Thus, $$ r = \begin{bmatrix}0&-d\end{bmatrix}^T $$ and the second equation of motion can be rewritten as:

$$
J\ddot{\theta}=\rho d \sin\phi
$$

which is combined with the previous derivations to get the complete set of second order nonlinear dynamics:

$$
\begin{aligned}
m\ddot{p}_x&=\rho \sin(\phi-\theta)\\
m\ddot{p}_y&=\rho \cos(\phi-\theta)-mg\\
J\ddot{\theta}&=\rho d \sin\phi
\end{aligned}
$$

---

#### Linearization

The states of the system are $$ x = \begin{bmatrix}p_x&p_y&\theta&v_x&v_y&\omega\end{bmatrix}^T $$ where $$ v_x $$, $$ v_y $$, and $$ \omega $$ are the time derivatives of $$ p_x $$, $$ p_y $$, and $$ \theta $$ respectively and the input is $$ u = \begin{bmatrix}\rho&\phi\end{bmatrix}^T $$. To determine the inputs and states $$ (x^*,u^*) $$ such that the rocket hovers at some arbitrary point $$ p_0 = \begin{bmatrix}p_{x0}&p_{y0}\end{bmatrix}^T $$, the following must be true:

$$
\begin{aligned}
\ddot{p}_x&=\ddot{p}_y=\ddot{\theta}=0\\
\dot{p}_x&=\dot{p}_y=\dot{\theta}=0\\
p_x^*&=p_{x0}\\
p_y^*&=p_{y0}
\end{aligned}
$$

The equations of motion become:

$$
\begin{aligned}
0&=\rho^* \sin(\phi^*-\theta^*)\\
0&=\rho^* \cos(\phi^*-\theta^*)-mg\\
0&=\rho^* d \sin\phi^*
\end{aligned}
$$

With $$ \rho > 0 $$, these equations imply $$ \sin(\phi^*-\theta^*) = 0 $$, $$ \sin \phi^*=0 $$, and $$ \rho^*\cos(\phi^*-\theta^*)=mg $$. To guarantee the physically relevant solution with upward thrust, $$ \phi^* = 0 $$, $$ \theta^* = 0 $$, and $$ \rho^* = mg $$. Therefore, the equilibrium state and input for hovering at an arbitrary point $$ p_0 $$ are:

$$
\begin{aligned}
x^*&=\begin{bmatrix}p_{x0}&p_{y0}&0&0&0&0\end{bmatrix}^T\\
u^*&=\begin{bmatrix}\rho^*\\\phi^*\end{bmatrix}=\begin{bmatrix}mg\\0\end{bmatrix}
\end{aligned}
$$

Next, the state space is linearized about the equilibrium by

$$
\Delta \dot{x} = A \Delta x + B \Delta u
$$

where $\Delta x = x - x^\*$ and $\Delta u = u - u^\*$.
To compute the Jacobians,

$$
A = \left.\frac{\partial f}{\partial x}\right|_{(x^*,u^*)}
\qquad \text{and} \qquad
B = \left.\frac{\partial f}{\partial u}\right|_{(x^*,u^*)}
$$

the full state dynamics are needed:

$$
\dot{x}=f(x,u)=\begin{bmatrix}\dot{p}_x\\\dot{p}_y\\\dot{\theta}\\\dot{v}_x\\\dot{v}_y\\\dot{\omega}\end{bmatrix}=\begin{bmatrix}v_x\\v_y\\\omega\\\frac{\rho}{m}\sin(\phi-\theta)\\\frac{\rho}{m}\cos(\phi-\theta)-g\\\frac{\rho d}{J}\sin\phi\end{bmatrix}
$$

With $$ A_{ij} = \frac{\partial f_i}{\partial x_j} $$ and $$ B_{ik} = \frac{\partial f_i}{\partial u_k} $$ for each state and input, and with values $$ m = 20 $$ kg, $$ J = 4 $$ kgm^2, and $$ d = 0.75 $$ m, the full state matrices are:

$$
A = \begin{bmatrix}0&0&0&1&0&0\\0&0&0&0&1&0\\0&0&0&0&0&1\\0&0&-g&0&0&0\\0&0&0&0&0&0\\0&0&0&0&0&0\end{bmatrix} \quad\quad\quad B = \begin{bmatrix}0&0\\0&0\\0&0\\0&g\\\frac{1}{20}&0\\0&\frac{15g}{4}\end{bmatrix}
$$

The matrix $$ A $$ does not depend on the model parameters, and it is observed that the eigenvalues of $$ A $$ are:

$$
\lambda_1 = \lambda_2 =\quad...\quad= \lambda_6 = 0
$$

With all eigenvalues lying at the origin, the stability of the equilibrium is not asymptotically stable by definition. Because the eigenvalue at 0 has nontrivial Jordan blocks, the equilibrium is also not Lyapunov stable. Therefore the equilibrium is unstable in the open loop. The open-loop response of the rocket is compared near the equilibrium for both the linearized model and the full nonlinear model. The initial conditions consist of a small perturbation in pitch angle $$ \theta $$ and no control input is applied $$ (u=0) $$.

img

The position $$ p_x $$ drifts rapidly in both simulations. Because the rocket is tilted to start, the thrust vector has a constant horizontal component which causes $$ p_x $$ to grow unbounded in both models. This demonstrates the open-loop instability of the hover equilibrium. The main discrepancy in the two simulations appears in the vertical position $$ p_y $$. In the linearized dynamics $$ p_y $$ remains constant since the linearization assumes small angles and treats the thrust as fully canceling gravity. In the nonlinear model, however, the vertical thrust component is $$ mg\cos\theta_0<mg $$ for some initial pitch $$ \theta_0 $$, so the vertical position gradually descends due to a force imbalance.

---

### Control System Design

With a complete formulation of both the nonlinear dynamics and the linearized version, controllability and observability may be explored in the following control system designs. Later, the full controller-observer design will be utilized for certain demonstration scenarios.

---

#### Controllability

To prove that the linearized system is controllable, the controllability matrix is computed. However, it is noted that the matrix $$ A $$ is nilpotent of order 4 $$ (A^4 = 0) $$. Thus, only the first four blocks of the controllability matrix are required:

$$
\begin{aligned}
C&=\begin{bmatrix}B&AB&A^2B&A^3B\end{bmatrix}\\[4pt]
&= \begin{bmatrix}0&0&0&g&0&0&0&\frac{-15g^2}{4}\\0&0&\frac{1}{20}&0&0&0&0&0\\0&0&0&\frac{15g}{4}&0&0&0&0\\0&g&0&0&0&\frac{-15g^2}{4}&0&0\\\frac{1}{20}&0&0&0&0&0&0&0\\0&\frac{15g}{4}&0&0&0&0&0&0\end{bmatrix}
\end{aligned}
$$

The matrices $$ A $$ and $$ C $$ share the same rank of 6, and thus the pair $$ (A,B) $$ is controllable.

To demonstrate controllability, a linear quadratic regulator (LQR) controller will be developed to hover the rocket. This approach is chosen over closed-loop pole placement because the large dimension of the state space (6 states) would require a lot of manual tuning with several trials. Since the system is multi-input and strongly coupled, the LQR provides a more systematic tuning framework by enabling the tradeoff between balancing position, attitude, and control effort. The LQR controller minimizes the quadratic cost

$$
J=\int_0^\infty(\Delta x^TQ \Delta x + \Delta u^TR \Delta u)dt
$$

with weighting matrices $$ Q $$ and $$ R $$ which reflect the importance of different states in hover. The position errors were given moderately high weights to ensure that the rocket returns to the hover point, whereas the pitch angle and rate were weighted more heavily because attitude errors quickly lead to extreme position drifts. Control effort weighting in the $$ R $$ matrix was chosen to balance stability with actuator usage. The LQR problem was then solved using the continuous-time algebraic Riccati equation

$$
A^TP+PA-PBR^{-1}B^TP+Q=0
$$

to solve for $$ P $$, which is then used to compute the optimal feedback gain: $$ K = R^{-1}B^TP $$. With this formulation, the resulting LQR gain matrix is:

$$
K = \begin{bmatrix}0&10&0&0&20.25&0\\-10&0&55.25&-11.07&0&13.13\end{bmatrix}
$$

The resulting eigenvalues of the closed-loop system $$ (A-BK) $$ are $$ \lambda = -369.17, -2.42, -1.39 \pm 1.45i, -0.51 \pm 0.49i $$, and asymptotic stability is guaranteed due to all real parts being negative.

Below, the closed-loop response of the linearized and nonlinear rocket dynamics are compared under the LQR controller, using an initial condition that includes significant horizontal and vertical displacement and a $$ 25 \deg $$ pitch error. As shown, in both simulations the controller sucecssfully stabilizes the rocket and drives states back to the hover equilibrium.

img

The linearized model shows a smooth response in all states, as expected, and the nonlinear system exhibits a similar qualitative behavior but with noticeable deviations in transient response. The nonlinear $$ p_x $$ and $$ p_y $$ trajectories show overshoot and a slower return to equilibrium due to the nonlinear thrust coupling terms. Overall, the comparison demonstrates that the LQR-stabilized linear model predicts the behavior of the nonlinear system, performance degrades under large disturbances, and the closed-loop equilibrium is asymptotically stable.

---

#### Observability

For observation purposes, it is assumed that there are independent sensors measuring the positions as well as the angular velocity. Therefore, in the state space formulation, the following $$ C $$ matrix is established:

$$
C = \begin{bmatrix}1&0&0&0&0&0\\0&1&0&0&0&0\\0&0&0&0&0&1\end{bmatrix}
$$

The linearized system is proven to be observable by computing the observability matrix. For the same reason as the controllability matrix, the highest order computation involves $$ A^3 $$ due to the nilpotency of $$ A $$. 

$$
O = \begin{bmatrix}C\\CA\\CA^2\\CA^3\end{bmatrix}
$$

The result is a $$ 12 \times 6 $$ matrix with rank 6. Because the observability matrix shares the same rank as $$ A $$, the pair $$ (A,C) $$ is observable.

To implement the state observer on the system, a Kalman filter is developed. While pole placement methods are simple to implement, they do not explicitly describe the tradeoff between noise and responsiveness. By tuning the noise covariances $$ Q_n $$ and $$ R_n $$, real-time state estimation (sensor fusion) is provided, leading to better accuracy and robustness. First a linear state observer is introduced to estimate the full set of states using the available measurements:

$$
\dot{\hat{x}} = A\hat{x} = Bu + L(y-C\hat{x})
$$

where $$ \hat{x} $$ is the estimated state and $$ L $$ is the observer gain matrix. The estimation error is defined as $$ e = x - \hat{x} $$ which elads to the error dynamics $$ \dot{e} = (A-LC)e $$. The Kalman filter determines $$ L $$ by assuming the system is subject to stochastic disturbances:

$$
\dot{x}=Ax+w \quad\quad\quad y=Cx+v
$$

where $$ w $$ is a process noise with covariance $$ Q_n $$ and $$ v $$ is a measurement noise with covariance $$ R_n $$. The goal is to find the gain $$ L $$ that minimizes the steady-state estimation error $$ \mathbb{E}[ee^T] $$. First, the optimal estimation error covariance matrix $$ P $$ is solved from the continuous-time algebraic Riccati equation:

$$
AP+PA^T-PC^TR_n^{-1}CP+Q_n=0
$$

Given $$ P $$, the Kalman gain is then computed as:

$$
L=PC^TR_n^{-1}
$$

The closed-loop state observer performances are shown below, showing both the true and estimated states. Among the measured states, $$ \omega $$ exhibits a short transient in the estimate because the Kalman filter blends prediction and sensor data according to the Kalman gain, resulting in a brief but stable correction phase.

img

Next, the LQR controller code is modified to utilize the estimated states as feedback for both the linearized and nonlinear systems. The closed-loop response of the two systems under combined LQG control are compared, using estimated states obtained from the Kalman observer. It is shown that both systems converge, but not identically, which is expected due to the nonlinear couplings in the true dynamics.

img

In both cases, the system converges to the hover equilibrium, confirming stability of the augmented plant-observer model. The nonlinear system exhibits larger transient errors due to thrust nonlinearities and saturation but preserves the qualitative behavior predicted by the linear model. Further, the eigenvalues of the closed-loop observer $$ A-LC $$ are $$ \lambda = -1.15 \pm 1.44i, -1.29, -3.15, -1.27 \pm 1.25i $$, which convey asymptotic stability due to all of the real parts being negative. The tracking patterns for the trajectories are shown below. In both systems, estimated states converge rapidly to the true states, confirming observability and stability. As expected, there is a larger transient error for $$ \theta $$ since it is not directly measured; the fact that $$ \theta $$ still converges cleanly demonstrates the proper Kalman gain tuning.

img

---

### Demonstrations

Now that the controller and observer have been designed separately and now combined, it will be demonstrated for different trajectory scenarios. For the following demonstrations, it is assumed that the rocket has two limitations on the input: $$ 0 \le \rho \le 400 $$ N and $$ |\phi| \le \frac{\pi}{4} $$. The controller configuration will be tested and modified for a landing maneuver as well as a waypoint-based flight.

---

#### Landing
